#!/bin/sh
set -x

fail() {
    echo $1 1>&2
    echo "Usage: $0 [install|uninstall]" 1>&2
    exit 1
}

install() {
    docker run \
        -v /:/host \
        --entrypoint sh \
        --rm \
        ${IMAGE:-timonier/atom}:${TAG:-1.7.4} -c "cp $1 /host/$1"
}

if [ $# -lt 1 ] ; then
    fail "Invalid number of arguments."
fi

if [ $(id -u) -ne 0 ] ; then
    fail "Impossible to prepare the system without root privileges."
fi

if [ $(uname) != "Linux" ] ; then
    fail "Impossible to prepare another operating system than Linux."
fi

case $1 in
    install )
        curl -sLo /usr/local/bin/apm "https://github.com/timonier/atom/raw/master/bin/apm"
        chmod +x /usr/local/bin/apm

        curl -sLo /usr/local/bin/atom "https://github.com/timonier/atom/raw/master/bin/atom"
        chmod +x /usr/local/bin/atom

        install /usr/share/applications/atom.desktop
        sed -i 's@/usr/share/atom/@@g' /usr/share/applications/atom.desktop

        install /usr/share/pixmaps/atom.png
    ;;

    uninstall )
        rm -f /usr/local/bin/apm
        rm -f /usr/local/bin/atom
        rm -f /usr/share/applications/atom.desktop
        rm -f /usr/share/pixmaps/atom.png
    ;;

    * )
        fail "Argument $1 is invalid."
esac
